<html>
<head>
<title>Send to Computer</title>
<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<script type="text/javascript">


if (typeof XMLHttpRequest == "undefined")
XMLHttpRequest = function () {
  try { return new ActiveXObject("Msxml2.XMLHTTP.6.0"); }
  catch (e) {}
  try { return new ActiveXObject("Msxml2.XMLHTTP.3.0"); }
  catch (e) {}
  try { return new ActiveXObject("Msxml2.XMLHTTP"); }
  catch (e) {}
  //Microsoft.XMLHTTP points to Msxml2.XMLHTTP.3.0 and is redundant
  throw new Error("This browser does not support XMLHttpRequest.");
};

function doRequest() {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState != 4) return;

    if (xhr.status == 200 && xhr.responseText != "") {
      document.getElementById("recent").style.display = "inline";
      var text = document.createTextNode(xhr.responseText);
      var link = document.createElement('a');
      link["href"] = xhr.responseText;
      link.appendChild(text);
      node = document.createElement("li");
      node.appendChild(link);

      parentNode = document.getElementById("links");
      if (parentNode.children.length > 0) {
        parentNode.insertBefore(node, parentNode.children[0]);
      } else {
        parentNode.appendChild(node);
      }
      window.open(xhr.responseText);
      doRequest();
    }
  };
  xhr.open('GET', '/poll?browser=' + id, true);
  xhr.send(null);
}

function requestLoop() {
  doRequest();
  setTimeout(function() {
      requestLoop();
  }, 30000);
}

var mysocket = null;

function makeChannel() {
  if (mysocket != null) mysocket.close();

  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState != 4) return;

    if (xhr.status == 200 && xhr.responseText != "") {
      var chid = xhr.responseText;

      var channel = new goog.appengine.Channel(chid);
      var socket = channel.open();
      mysocket = socket;

      socket.onmessage = function(evt) {
        doRequest(id);
      }

      socket.onerror = function(evt) {
      }
    }
  }
  xhr.open('GET', '/channel?browser=' + id, true);
  xhr.send(null);
}
function channelLoop() {
  makeChannel();
  setTimeout(function() {
    channelLoop();
  }, 3600000);
}

function init() {
  id = '{{ browser_id }}';
  requestLoop();
  qrUrl = "http://chart.apis.google.com/chart?cht=qr&" +
          "chs=350x350&chl=http%3A%2F%2F" +
          "{{ base_url }}%2Fassociate%3Fbrowser%3D" + id;
  document.getElementById("image").innerHTML = '<img align="left" src="' + qrUrl + '">';
  channelLoop();
}
</script>
</head>

<body onload="init();">
<center><h1>Send to Computer</h1></center>
<h2>How to use it:</h2>
<ul>
<li>On your phone scan the displayed qr-code using <code>Barcode Scanner</code> app. Select open in Browser and choose <code>Send to Computer</code> application. This will associate your phone with the browser window.</li>
<li>Now you can 'Share' pages with 'Send to Computer' and new windows/tabs will open in this browser automatically.</li>
<li>Don't forget to disable popup blocker otherwise the windows or tabs will be blocks.</li>
<li>Try sending a page: in your phone <code>Browser</code>, press Menu -&gt; More -&gt; 'Share Page', select 'Send to Computer'. The browser window or tab should open next to this one within 2 minutes with the page you've send.</li>

<li>You can bookmark this page and even open on other computer to access the links you send from you android device. You can close this page and open it later and it will instantly open all the links you sent in new windows. <b><h3>If you open <code>http://send-to-computer.appspot.com</code> another time you will receive different browser id and will not have an access to your shared links. Bookmark current page with your current browser id!</h3></b>
</li>

</ul>
<span id="image"></span>
<h2>How it works:</h2>
  <ul>
  <li>
    When you scan qr-code your phone remembers the number generated by this browser window.
  </li>
  <li>
    When you share a page on your phone - it sends the link and your unique number to the 'send-to-computer.appspot.com'.
  </li> 
  <li>
    Every 2 minutes this browser window fetches new links from 'send-to-computer.appspot.com' and opens them in new windows.
  </li>
</ul>
<span id="recent" style="display:none">
<h2>Recent links received:</h2>
<ul id="links">
<span id="before"></span>
</ul>
</span>
</body>
